import pymongo
import csv
from datetime import datetime, timedelta
import sys
import getopt

def get_mongodb_collection(db_name, collection_name):
    try:
        mongo_uri = "abco://" + db_name + "/?maxPoolSize=150"
        client = pymongo.MongoClient(mongo_uri)
        db = client[db_name]
        collection = db[collection_name]
        return collection
    except Exception as e:
        print(f"Error accessing collection '{collection_name}':", e)
        return None

def generate_unique_data_report(db_name, collection1_name, collection2_name, fromdate1, fromdate2):
    try:
        # Get collections
        collection1 = get_mongodb_collection(db_name, collection1_name)
        collection2 = get_mongodb_collection(db_name, collection2_name)
        if not collection1 or not collection2:
            return

        # Define the time ranges
        fromdate1_dt = datetime.now() - timedelta(hours=fromdate1)
        fromdate2_dt = datetime.now() - timedelta(hours=fromdate2)

        # Query collection1 for data created after fromdate1
        query1 = {"createdAt": {"$gt": fromdate1_dt}}
        cursor1 = collection1.find(query1)

        # Query collection2 for data with source.createdTs after fromdate2
        query2 = {"source.createdTs": {"$gt": fromdate2_dt}}
        cursor2 = collection2.find(query2)

        # Create a set of IDs and join dates from collection2
        collection2_data = {(data["ID_ABC"], data["join_date"]) for data in cursor2}

        # Create a list of data from collection1 that is not in collection2
        unique_data = []
        for data in cursor1:
            data_id = data.get("ID_ABC")
            join_date = data.get("join_date")
            if data_id is not None and join_date is not None and (data_id, join_date) not in collection2_data:
                unique_data.append({"ID_ABC": data_id, "join_date": join_date})

        # Write the unique data to a CSV file
        csv_file = "unique_data_report.csv"
        with open(csv_file, mode="w", newline="") as file:
            writer = csv.DictWriter(file, fieldnames=["ID_ABC", "join_date"])
            writer.writeheader()
            for data in unique_data:
                writer.writerow(data)

        print("Report generated successfully in", csv_file)

    except Exception as e:
        print("An error occurred:", e)

def main(argv):
    mongo_uri = ''
    db_name = ''
    collection1_name = ''
    collection2_name = ''
    fromdate1 = None
    fromdate2 = None

    try:
        opts, args = getopt.getopt(argv,"hu:d:c:p:f:g:",["uri=","database=","collection1=","collection2=","fromdate1=","fromdate2="])
    except getopt.GetoptError:
        print('Usage: script.py -u <MongoDB URI> -d <database> -c <collection1> -p <collection2> -f <fromdate1> -g <fromdate2>')
        sys.exit(2)

    for opt, arg in opts:
        if opt == '-h':
            print('Usage: script.py -u <MongoDB URI> -d <database> -c <collection1> -p <collection2> -f <fromdate1> -g <fromdate2>')
            sys.exit()
        elif opt in ("-u", "--uri"):
            mongo_uri = arg
        elif opt in ("-d", "--database"):
            db_name = arg
        elif opt in ("-c", "--collection1"):
            collection1_name = arg
        elif opt in ("-p", "--collection2"):
            collection2_name = arg
        elif opt in ("-f", "--fromdate1"):
            fromdate1 = float(arg)
        elif opt in ("-g", "--fromdate2"):
            fromdate2 = float(arg)

    if not all([mongo_uri, db_name, collection1_name, collection2_name, fromdate1, fromdate2]):
        print('All parameters are required')
        sys.exit(2)

    try:
        # Generate the report
        generate_unique_data_report(db_name, collection1_name, collection2_name, fromdate1, fromdate2)

    except pymongo.errors.ConnectionFailure as e:
        print("Connection to MongoDB failed:", e)
    except Exception as e:
        print("An error occurred:", e)

if __name__ == "__main__":
    main(sys.argv[1:])
